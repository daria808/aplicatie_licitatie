--DROP DATABASE AuctionApp

CREATE DATABASE AuctionApp

CREATE TABLE [dbo].[Users] (
    [id_user]    INT             IDENTITY (1, 1) NOT NULL,
    [fisrt_name] NVARCHAR (50)   NOT NULL,
    [last_name]  NVARCHAR (50)   NOT NULL,
    [username]   NVARCHAR (20)   NOT NULL,				-- >5 <20
    [email]      NVARCHAR (150)  NOT NULL,
    [password]   NVARCHAR (100)  NOT NULL,				-- max SHA-256 length
    [salt]       NVARCHAR (100)  NOT NULL,
    [created_at] DATETIME        DEFAULT (getdate()) NULL, -- nu s-a logat 
    [last_login] DATETIME        DEFAULT (NULL) NULL,
    [balance]    DECIMAL (10, 2) NULL,

    PRIMARY KEY CLUSTERED ([id_user] ASC),
    UNIQUE NONCLUSTERED ([email] ),
	UNIQUE NONCLUSTERED ([username] ),

    CONSTRAINT [CK_UserBalance] CHECK ([balance]>=(0)),
    CONSTRAINT [CK_UserAccountCreationDate] CHECK ([created_at]<=getdate()),
    CONSTRAINT [CK_UserLastLoginDate] CHECK ([last_login]<=getdate())
);


CREATE TABLE [dbo].[User type] (
    [id_type] INT           IDENTITY (1, 1) NOT NULL,
    [name]    NVARCHAR (50) NOT NULL,

    PRIMARY KEY CLUSTERED ([id_type] ASC)
);

INSERT INTO [dbo].[User type] ([name])
VALUES ('admin'),
       ('ofertant'),
       ('solicitant');

CREATE TABLE [dbo].[User role] (
    [id_role]   INT      IDENTITY (1, 1) NOT NULL,
    [id_user]   INT      NOT NULL,
    [id_tip]    INT      NOT NULL,
    [role_date] DATETIME DEFAULT (getdate()) NOT NULL,

    PRIMARY KEY CLUSTERED ([id_role] ASC),
    FOREIGN KEY ([id_user]) REFERENCES [dbo].[Users] ([id_user]) ON DELETE CASCADE,
    FOREIGN KEY ([id_tip]) REFERENCES [dbo].[User type] ([id_type]) ON DELETE CASCADE,

    CONSTRAINT [CK_UserRoleDate] CHECK ([role_date]<=getdate())
);


CREATE TABLE [dbo].[Product] (
    [id_product]     INT            IDENTITY (1, 1) NOT NULL,
    [name]           NVARCHAR (100) NOT NULL,
    [description]    NVARCHAR (MAX) NOT NULL,
    [inventory_date] DATETIME       DEFAULT (getdate()) NULL,

    PRIMARY KEY CLUSTERED ([id_product] ASC),
    CONSTRAINT [CK_ProductInventoryDate] CHECK ([inventory_date]<=getdate())
);


-- WATCH --

CREATE TABLE [dbo].[Watch mechanism] (
    [id_mechanism] INT           IDENTITY (1, 1) NOT NULL,
    [mechanism]    NVARCHAR (50) NOT NULL,

    PRIMARY KEY CLUSTERED ([id_mechanism] ASC)
);

INSERT INTO [dbo].[Watch mechanism] ([mechanism])
VALUES ('mecanic'),
       ('quartz'),
       ('smartwatch');

CREATE TABLE [dbo].[Watch type] (
    [id_watch_type] INT           IDENTITY (1, 1) NOT NULL,
    [type]          NVARCHAR (50) NOT NULL,
    PRIMARY KEY CLUSTERED ([id_watch_type] ASC)
);

INSERT INTO [dbo].[Watch type] ([type])
VALUES ('digital'),
       ('analogic');

CREATE TABLE [dbo].[Watch] (
    [id_watch]     INT            IDENTITY (1, 1) NOT NULL,
    [id_product]   INT            NULL,
    [id_mechanism] INT            NULL,
    [diameter]     DECIMAL (5, 2) NOT NULL,
    [manufacturer] NVARCHAR (100) NOT NULL,

    PRIMARY KEY CLUSTERED ([id_watch] ASC),
    FOREIGN KEY ([id_product]) REFERENCES [dbo].[Product] ([id_product]) ON DELETE CASCADE,
    FOREIGN KEY ([id_mechanism]) REFERENCES [dbo].[Watch mechanism] ([id_mechanism]) ON DELETE CASCADE,

    CONSTRAINT [CK_WatchDiameter] CHECK ([diameter]>(0))
);

-- PAINTING --

CREATE TABLE [dbo].[Painting type] (
    [id_painting_type] INT           IDENTITY (1, 1) NOT NULL,
    [type]             NVARCHAR (50) NOT NULL,

    PRIMARY KEY CLUSTERED ([id_painting_type] ASC)
);

INSERT INTO [dbo].[Painting type] ([type])
VALUES ('pictura în ulei'),
       ('acuarela'),
       ('acrilic'),
       ('fresca'),
       ('pastel');

CREATE TABLE [dbo].[Painting] (
    [id_painting]   INT            IDENTITY (1, 1) NOT NULL,
    [id_produs]     INT            NOT NULL,
    [id_type]       INT            NOT NULL,
    [artist]        NVARCHAR (100) NOT NULL,
    [creation_year] INT            NOT NULL,
    [length]        DECIMAL (8, 2) NOT NULL,
    [width]         DECIMAL (8, 2) NOT NULL,

    PRIMARY KEY CLUSTERED ([id_painting] ASC),
    FOREIGN KEY ([id_produs]) REFERENCES [dbo].[Product] ([id_product]) ON DELETE CASCADE,
    FOREIGN KEY ([id_type]) REFERENCES [dbo].[Painting type] ([id_painting_type]) ON DELETE CASCADE,

    CHECK ([length]>(0)),
    CHECK ([width]>(0)),
    CONSTRAINT [CK_PaintingYear] CHECK ([creation_year]<=datepart(year,getdate()))
);

-- BOOK --

CREATE TABLE [dbo].[Book condition] (
    [id_book_condition] INT            IDENTITY (1, 1) NOT NULL,
    [condition]         NVARCHAR (100) NOT NULL,

    PRIMARY KEY CLUSTERED ([id_book_condition] ASC)
);

INSERT INTO [dbo].[Book condition] ([condition])
VALUES ('noua'),
       ('foarte buna'),
       ('buna'),
       ('deteriorata');


CREATE TABLE [dbo].[Book] (
    [id_book]          INT            IDENTITY (1, 1) NOT NULL,
    [id_product]       INT            NOT NULL,
    [id_condition]     INT            NOT NULL,
    [author]           NVARCHAR (100) NOT NULL,
    [publication_year] INT            NOT NULL,
    [publishing_house] NVARCHAR (100) NOT NULL,
    [page_number]      INT            NOT NULL,
    [book_language]    NVARCHAR (50)  NOT NULL,

    PRIMARY KEY CLUSTERED ([id_book] ASC),
    FOREIGN KEY ([id_product]) REFERENCES [dbo].[Product] ([id_product]) ON DELETE CASCADE,
    FOREIGN KEY ([id_condition]) REFERENCES [dbo].[Book condition] ([id_book_condition]) ON DELETE CASCADE,

    CHECK ([page_number]>(0)),
    CONSTRAINT [CK_BookPublicationYear] CHECK ([publication_year]<=datepart(year,getdate()))
);

-- JEWELRY --

CREATE TABLE [dbo].[Jewelry type] (
    [id_jewelry_type] INT           IDENTITY (1, 1) NOT NULL,
    [type]            NVARCHAR (50) NOT NULL,

    PRIMARY KEY CLUSTERED ([id_jewelry_type] ASC)
);

INSERT INTO [dbo].[Jewelry type] ([type])
VALUES ('cercei'),
       ('lanțisor'),
       ('inel'),
       ('bratara'),
       ('colier'),
       ('brosa')

CREATE TABLE [dbo].[Jewelry] (
    [id_jewelry]    INT             IDENTITY (1, 1) NOT NULL,
    [id_product]    INT             NOT NULL,
    [id_type]       INT             NOT NULL,
	[brand]			NVARCHAR (50)   NOT NULL,
    [weight]        DECIMAL (10, 2) NOT NULL,
    [creation_year] INT             NOT NULL,

    PRIMARY KEY CLUSTERED ([id_jewelry] ASC),
    FOREIGN KEY ([id_product]) REFERENCES [dbo].[Product] ([id_product]) ON DELETE CASCADE,
    FOREIGN KEY ([id_type]) REFERENCES [dbo].[Jewelry type] ([id_jewelry_type]) ON DELETE CASCADE,

    CONSTRAINT [CK_JewerlyYear] CHECK ([creation_year]<=datepart(year,getdate())),
    CONSTRAINT [CK_JewerlyWeight] CHECK ([weight]>(0))
);


-- SCULPTURE --

CREATE TABLE [dbo].[Sculpture material] (
    [id_sculpture_material] INT           IDENTITY (1, 1) NOT NULL,
    [material]              NVARCHAR (50) NOT NULL,

    PRIMARY KEY CLUSTERED ([id_sculpture_material] ASC)
);

INSERT INTO [dbo].[Sculpture material] ([material])
VALUES 
('marmura'),
('granit'),
('calcar'),
('bronz'),
('fier'),
('otel'),
('lut'),
('sticla');

CREATE TABLE [dbo].[Sculpture] (
    [id_sculpture]          INT            IDENTITY (1, 1) NOT NULL,
    [id_product]            INT            NOT NULL,
    [id_sculpture_material] INT            NOT NULL,
    [artist]                NVARCHAR (100) NOT NULL,
    [length]                DECIMAL (8, 2) NOT NULL,
    [width]                 DECIMAL (8, 2) NOT NULL,
    [depth]                 DECIMAL (8, 2) NOT NULL,

    PRIMARY KEY CLUSTERED ([id_sculpture] ASC),
    FOREIGN KEY ([id_product]) REFERENCES [dbo].[Product] ([id_product]) ON DELETE CASCADE,
    FOREIGN KEY ([id_sculpture_material]) REFERENCES [dbo].[Sculpture material] ([id_sculpture_material]) ON DELETE CASCADE,

    CHECK ([length]>(0)),
    CHECK ([width]>(0)),
    CHECK ([depth]>(0))
);


-- AUCTION --

CREATE TABLE [dbo].[Auction type] (
    [id_auction_type] INT           IDENTITY (1, 1) NOT NULL,
    [type_name]       VARCHAR (100) NOT NULL,
    PRIMARY KEY CLUSTERED ([id_auction_type] ASC)
);

INSERT INTO [dbo].[Auction type] ([type_name])
VALUES 
    ('Ceasuri'),
    ('Bijuterii'),
    ('Carti'),
    ('Sculpturi'),
    ('Tablouri');

CREATE TABLE [dbo].[Auction] (
    [id_auction]      INT           IDENTITY (1, 1) NOT NULL,
	[id_auction_type] INT           NOT NULL,
	[id_user]         INT           NOT NULL,
	[auction_number]  INT           NOT NULL,
	[name]            VARCHAR (250) NOT NULL,
	[location]        VARCHAR (250) NULL,
    [start_time]      DATETIME      NOT NULL,
    [end_time]        DATETIME      NOT NULL,
	[description]     VARCHAR (MAX) NULL,
    [image_path]      VARCHAR (255) DEFAULT ('C:/Users/laris/Desktop/Client_ADBD/Client_ADBD/Views/photos/no-image_image.jpg') NOT NULL,

    PRIMARY KEY CLUSTERED ([id_auction] ASC),
	FOREIGN KEY ([id_auction_type]) REFERENCES [dbo].[Auction type] ([id_auction_type])  ON DELETE CASCADE,
	FOREIGN KEY ([id_user]) REFERENCES [dbo].[Users] ([id_user]) ON DELETE CASCADE,
    CONSTRAINT [uq_auction_number] UNIQUE NONCLUSTERED ([auction_number] ASC),
    CONSTRAINT [chk_end_time] CHECK ([end_time]>[start_time]),
    CONSTRAINT [chk_auction_number_positive] CHECK ([auction_number]>(0))
);



-- POST --

CREATE TABLE [dbo].[Post status] (
    [id_status]   INT           IDENTITY (1, 1) NOT NULL,
    [status_name] NVARCHAR (50) NOT NULL,
    PRIMARY KEY CLUSTERED ([id_status] ASC)
);

INSERT INTO [dbo].[Post status] ([status_name])
VALUES ('Adjudecat'), ('Neadjudecat');

CREATE TABLE [dbo].[Post] (
    [id_post]     INT             IDENTITY (1, 1) NOT NULL,
    [id_product]  INT             NOT NULL,
    [id_status]   INT             NOT NULL,
    [id_auction]  INT             NOT NULL,
    [start_price] DECIMAL (10, 2) NOT NULL,
    [list_price]  DECIMAL (10, 2) NOT NULL,
    [created_at]  DATETIME        DEFAULT (getdate())NOT NULL,
    [image_path]  VARCHAR (255)   DEFAULT ('C:/Users/laris/Desktop/Client_ADBD/Client_ADBD/Views/photos/no-image_image.jpg') NOT NULL,
  
	PRIMARY KEY CLUSTERED ([id_post] ASC),
    FOREIGN KEY ([id_product]) REFERENCES [dbo].[Product] ([id_product]) ON DELETE CASCADE,
    FOREIGN KEY ([id_status]) REFERENCES [dbo].[Post status] ([id_status]) ON DELETE CASCADE,
    FOREIGN KEY ([id_auction]) REFERENCES [dbo].[Auction] ([id_auction]) ON DELETE CASCADE,
    CONSTRAINT [CK_PostCreationDate] CHECK ([created_at]<=getdate())
);


-- BID --

CREATE TABLE [dbo].[Bid] (
    [id_bid]    INT             IDENTITY (1, 1) NOT NULL,
    [id_post]   INT             NOT NULL,
    [id_user]   INT             NOT NULL,
    [bid_price] DECIMAL (10, 2) NOT NULL,
    [bid_date]  DATETIME        DEFAULT (getdate()) NOT NULL,

    PRIMARY KEY CLUSTERED ([id_bid] ASC),
    FOREIGN KEY ([id_post]) REFERENCES [dbo].[Post] ([id_post]) ON DELETE CASCADE,
    FOREIGN KEY ([id_user]) REFERENCES [dbo].[Users] ([id_user]) ON DELETE CASCADE,
    CONSTRAINT [CK_BidDate] CHECK ([bid_date]<=getdate())
);

















